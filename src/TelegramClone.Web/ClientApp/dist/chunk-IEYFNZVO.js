import{A as $,D as _,Ga as Z,H as S,Ha as Q,I as H,R as E,S as C,T as F,U as K,V as W,X as Y,Y as I,aa as G,ba as O,ca as X,da as J,g as h,j as y,k as A,l as N,p as m,q as V,qa as T,sa as P,v as q,w}from"./chunk-X5AKF7Z7.js";import{a as p,b as v}from"./chunk-3RHWOS5U.js";var D=class a{constructor(){this.canvas=null;this.ctx=null;this.particles=[];this.animFrameId=null;this.pool=[];this.dpr=1;this.resizeTimer=null;this.resizeHandler=()=>this.debouncedResize();this.trailRafId=null}ensureCanvas(){this.canvas||(this.canvas=document.getElementById("particle-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d",{alpha:!0}),this.dpr=Math.min(window.devicePixelRatio||1,2),this.resize(),window.addEventListener("resize",this.resizeHandler,{passive:!0})))}debouncedResize(){this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>this.resize(),150)}resize(){if(!this.canvas)return;this.dpr=Math.min(window.devicePixelRatio||1,2);let e=window.innerWidth,t=window.innerHeight;this.canvas.width=e*this.dpr,this.canvas.height=t*this.dpr,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.ctx&&this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0)}ngOnDestroy(){window.removeEventListener("resize",this.resizeHandler),this.animFrameId&&cancelAnimationFrame(this.animFrameId),this.trailRafId&&cancelAnimationFrame(this.trailRafId),this.resizeTimer&&clearTimeout(this.resizeTimer)}getParticle(){return this.pool.pop()||{x:0,y:0,vx:0,vy:0,life:0,maxLife:1,size:4,color:"#fff",shape:"circle",gravity:0,friction:.98,rotation:0,rotationSpeed:0,opacity:1}}releaseParticle(e){this.pool.length<500&&this.pool.push(e)}emit(e,t,i={}){this.ensureCanvas();let{count:s=20,speed:n=5,spread:r=Math.PI*2,gravity:o=.15,friction:c=.97,size:l=5,sizeVariation:u=2,life:f=60,colors:b=["#3390ec","#4facfe","#00f2fe","#fff"],shapes:g=["circle","square"],direction:R=-Math.PI/2}=i;for(let M=0;M<s;M++){let d=this.getParticle(),j=R+(Math.random()-.5)*r,B=n*(.5+Math.random()*.5);d.x=e,d.y=t,d.vx=Math.cos(j)*B,d.vy=Math.sin(j)*B,d.life=f*(.5+Math.random()*.5),d.maxLife=d.life,d.size=l+(Math.random()-.5)*u,d.color=b[Math.floor(Math.random()*b.length)],d.shape=g[Math.floor(Math.random()*g.length)],d.gravity=o,d.friction=c,d.rotation=Math.random()*Math.PI*2,d.rotationSpeed=(Math.random()-.5)*.2,d.opacity=1,this.particles.push(d)}this.animFrameId||this.startLoop()}confetti(e,t){this.emit(e,t,{count:50,speed:8,spread:Math.PI*2,gravity:.12,friction:.97,size:7,sizeVariation:3,life:80,colors:["#ff6b6b","#ffd93d","#6bcb77","#4d96ff","#ff6eb4","#a66cff"],shapes:["square","circle"]})}sparkle(e,t){this.emit(e,t,{count:15,speed:3,spread:Math.PI*2,gravity:.02,friction:.96,size:3,life:40,colors:["#fff","#ffd700","#87ceeb"],shapes:["star","circle"]})}heartBurst(e,t){this.emit(e,t,{count:12,speed:5,spread:Math.PI,direction:-Math.PI/2,gravity:.08,friction:.97,size:10,life:70,colors:["#e53935","#f48fb1","#ff6090","#ff1744"],shapes:["heart"]})}sendTrail(e,t,i,s){let r=0,o=0,c=30,l=u=>{if(o||(o=u),u-o>=c){o=u;let f=r/8,b=e+(i-e)*f,g=t+(s-t)*f-Math.sin(f*Math.PI)*30;this.emit(b,g,{count:3,speed:1.5,spread:Math.PI*2,gravity:.05,life:25,size:3,colors:["#3390ec","#64b5f6","#90caf9"],shapes:["circle"]}),r++}r<8?this.trailRafId=requestAnimationFrame(l):this.trailRafId=null};this.trailRafId&&cancelAnimationFrame(this.trailRafId),this.trailRafId=requestAnimationFrame(l)}startLoop(){let e=()=>{if(this.particles.length===0){this.animFrameId=null,this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width/this.dpr,this.canvas.height/this.dpr);return}this.update(),this.draw(),this.animFrameId=requestAnimationFrame(e)};this.animFrameId=requestAnimationFrame(e)}update(){let e=0;for(;e<this.particles.length;){let t=this.particles[e];if(t.vy+=t.gravity,t.vx*=t.friction,t.vy*=t.friction,t.x+=t.vx,t.y+=t.vy,t.life--,t.rotation+=t.rotationSpeed,t.opacity=Math.max(0,t.life/t.maxLife),t.life<=0){this.releaseParticle(t);let i=this.particles.length-1;e<i&&(this.particles[e]=this.particles[i]),this.particles.length=i}else e++}}draw(){if(!this.ctx||!this.canvas)return;let e=this.ctx,t=this.canvas.width/this.dpr,i=this.canvas.height/this.dpr;e.clearRect(0,0,t,i);let s={};for(let n of this.particles)(s[n.shape]??=[]).push(n);for(let n in s)for(let r of s[n]){switch(e.save(),e.translate(r.x,r.y),e.rotate(r.rotation),e.globalAlpha=r.opacity,e.fillStyle=r.color,n){case"circle":e.beginPath(),e.arc(0,0,r.size/2,0,Math.PI*2),e.fill();break;case"square":e.fillRect(-r.size/2,-r.size/2,r.size,r.size);break;case"heart":this.drawHeart(e,r.size);break;case"star":this.drawStar(e,r.size/2);break}e.restore()}}drawHeart(e,t){let i=t/2;e.beginPath(),e.moveTo(0,i*.3),e.bezierCurveTo(-i,-i*.5,-i*1.5,i*.3,0,i*1.2),e.bezierCurveTo(i*1.5,i*.3,i,-i*.5,0,i*.3),e.fill()}drawStar(e,t){e.beginPath();for(let i=0;i<5;i++){let s=i*4*Math.PI/5-Math.PI/2;e[i===0?"moveTo":"lineTo"](Math.cos(s)*t,Math.sin(s)*t)}e.closePath(),e.fill()}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};var U=class a{constructor(){this.particles=y(D);this.themeTransitionTl=null}get g(){return typeof gsap<"u"?gsap:null}pageTransitionIn(e){if(!this.g)return;let t=this.g.timeline();t.fromTo(e,{x:"100%",opacity:.8,scale:.95},{x:"0%",opacity:1,scale:1,duration:.4,ease:"power3.out"});let i=typeof e=="string"?document.querySelector(e):e;if(i){let s=i.querySelector("header"),n=i.querySelector("footer");s&&t.fromTo(s,{y:-30,opacity:0},{y:0,opacity:1,duration:.3,ease:"power2.out"},"-=0.3"),n&&t.fromTo(n,{y:30,opacity:0},{y:0,opacity:1,duration:.3,ease:"power2.out"},"-=0.25")}}pageTransitionOut(e,t){if(!this.g){t();return}this.g.to(e,{x:"30%",opacity:0,scale:.92,duration:.3,ease:"power3.inOut",onComplete:t})}toggleActionButtons(e,t,i){this.g&&(e?(this.g.to(i,{scale:.3,opacity:0,rotation:-90,duration:.2,ease:"back.in(2)",overwrite:"auto"}),this.g.fromTo(t,{scale:.3,opacity:0,rotation:90},{scale:1,opacity:1,rotation:0,duration:.35,ease:"back.out(2)",delay:.05,overwrite:"auto"})):(this.g.to(t,{scale:.3,opacity:0,rotation:90,duration:.2,ease:"back.in(2)",overwrite:"auto"}),this.g.fromTo(i,{scale:.3,opacity:0,rotation:-90},{scale:1,opacity:1,rotation:0,duration:.35,ease:"back.out(2)",delay:.05,overwrite:"auto"})))}animateSendText(e){return new Promise(t=>{if(!this.g){t();return}let{sourceTextEl:i,targetPlaceholderEl:s,text:n,isMine:r}=e,o=i.getBoundingClientRect(),c=s.getBoundingClientRect(),l=document.createElement("div");l.innerText=n,l.style.cssText=`
        position:fixed; z-index:9999; pointer-events:none;
        left:${o.left}px; top:${o.top}px;
        width:${o.width}px; height:${o.height}px;
        font-size:15px; font-family:inherit; line-height:1.5;
        color:currentColor; padding:8px 12px; margin:0; box-sizing:border-box;
        white-space:pre-wrap; word-break:break-word;
        background:transparent; border-radius:18px;
        opacity:1; will-change:transform,opacity;
        transform-origin:${r?"bottom right":"bottom left"};
      `,document.body.appendChild(l);let u=r?"var(--tg-bubble-out)":"var(--tg-bubble-in, #fff)",f=r?"#ffffff":"var(--tg-text)",b=r?"18px 18px 4px 18px":"18px 18px 18px 4px";this.particles.sendTrail(o.left+o.width/2,o.top+o.height/2,c.left+c.width/2,c.top+c.height/2);let g=this.g.timeline({onComplete:()=>{l.remove(),t()}});g.to(l,{scale:.88,opacity:.9,duration:.12,ease:"power2.in"},0),g.to(l,{left:c.left,top:c.top,width:c.width,height:c.height,scale:1,opacity:1,backgroundColor:u,color:f,borderRadius:b,boxShadow:"0 1px 2px rgba(0,0,0,0.1)",padding:"8px 12px",duration:.3,ease:"power3.out"},.12),g.to(l,{scale:1.03,duration:.08,ease:"power1.out"},.42),g.to(l,{scale:1,duration:.12,ease:"power2.out"},.5)})}popInMessage(e){this.g&&this.g.fromTo(e,{scale:.85,y:20,opacity:0},{scale:1,y:0,opacity:1,duration:.4,ease:"elastic.out(1, 0.5)"})}popInMessageFromLeft(e){this.g&&this.g.fromTo(e,{x:-40,scale:.9,opacity:0},{x:0,scale:1,opacity:1,duration:.4,ease:"elastic.out(1, 0.6)"})}morphThemeTransition(e,t,i,s){let n=document.getElementById("theme-reveal-overlay"),r=typeof window<"u"&&window.matchMedia?.("(prefers-reduced-motion: reduce)").matches;if(!this.g||!n||r){i(),s?.();return}let o=window.innerWidth,c=window.innerHeight,l=Math.max(0,Math.min(e,o)),u=Math.max(0,Math.min(t,c)),f=Math.hypot(Math.max(l,o-l),Math.max(u,c-u))+36,b=getComputedStyle(document.documentElement),g=getComputedStyle(document.body).backgroundColor||b.getPropertyValue("--tg-bg").trim()||"#0f0f0f",R=b.getPropertyValue("--tg-primary").trim()||"#3390ec";this.themeTransitionTl?.kill(),this.resetThemeOverlay(n);let M=document.createElement("div");M.style.cssText=`
      position:absolute; inset:0; pointer-events:none;
      background:${g};
      clip-path:circle(0px at ${l}px ${u}px);
      opacity:0.92;
      will-change: clip-path, opacity;
      transform:translateZ(0);
    `;let d=document.createElement("div");d.style.cssText=`
      position:absolute; pointer-events:none;
      left:${l}px; top:${u}px; width:22px; height:22px; border-radius:9999px;
      background:radial-gradient(circle, ${R} 0%, rgba(255,255,255,0.28) 42%, rgba(255,255,255,0) 72%);
      transform:translate(-50%, -50%) scale(0.24);
      opacity:0.75;
      will-change: transform, opacity;
      mix-blend-mode:screen;
    `,n.append(M,d),n.style.pointerEvents="none",n.style.opacity="1",n.style.background="transparent",i(),this.themeTransitionTl=this.g.timeline({defaults:{overwrite:"auto"},onComplete:()=>{this.resetThemeOverlay(n),this.themeTransitionTl=null,s?.()}}),this.themeTransitionTl.to(M,{clipPath:`circle(${f}px at ${l}px ${u}px)`,duration:.46,ease:"power3.out"},0).to(M,{opacity:0,duration:.2,ease:"power2.out"},.28).to(d,{scale:Math.max(1.8,f/36),opacity:0,duration:.5,ease:"power2.out"},0).to(n,{opacity:0,duration:.16,ease:"power1.out"},.45)}resetThemeOverlay(e){e.replaceChildren(),e.style.opacity="0",e.style.pointerEvents="none",e.style.clipPath="",e.style.background=""}staggerListItems(e,t=".chat-item"){if(!this.g)return;let i=e.querySelectorAll(t);i.length&&this.g.fromTo(i,{y:30,opacity:0,scale:.95},{y:0,opacity:1,scale:1,duration:.4,stagger:.04,ease:"power2.out"})}elasticButton(e){this.g&&this.g.fromTo(e,{scale:.85},{scale:1,duration:.5,ease:"elastic.out(1.2, 0.4)"})}rippleEffect(e,t){let i=t.getBoundingClientRect(),s,n;"touches"in e?(s=e.touches[0].clientX-i.left,n=e.touches[0].clientY-i.top):(s=e.clientX-i.left,n=e.clientY-i.top),t.classList.contains("ripple-container")||t.classList.add("ripple-container");let r=document.createElement("span");r.className="ripple-wave";let o=Math.max(i.width,i.height)*2;r.style.cssText=`width:${o}px;height:${o}px;left:${s-o/2}px;top:${n-o/2}px;`,t.appendChild(r),setTimeout(()=>r.remove(),600)}shakeElement(e){this.g&&this.g.fromTo(e,{x:0},{x:5,duration:.08,repeat:5,yoyo:!0,ease:"power2.inOut",clearProps:"x"})}confettiExplosion(e,t){this.particles.confetti(e,t)}floatingHearts(e,t){this.particles.heartBurst(e,t)}slideInFromBottom(e,t=300){this.g&&this.g.fromTo(e,{y:t,opacity:0},{y:0,opacity:1,duration:.45,ease:"back.out(1.3)"})}slideOutToBottom(e,t){if(!this.g){t?.();return}this.g.to(e,{y:300,opacity:0,duration:.3,ease:"power2.in",onComplete:t})}scaleIn(e){this.g&&this.g.fromTo(e,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.35,ease:"back.out(1.7)"})}scaleOut(e,t){if(!this.g){t?.();return}this.g.to(e,{scale:.5,opacity:0,duration:.2,ease:"back.in(1.7)",onComplete:t})}smoothScrollTo(e,t){this.g&&this.g.to(e,{scrollTo:{y:t,autoKill:!1},duration:.6,ease:"power2.inOut"})}staggerMenuItems(e,t){if(!this.g)return;let i=e.querySelectorAll(t);this.g.fromTo(i,{y:10,opacity:0,scale:.9},{y:0,opacity:1,scale:1,duration:.25,stagger:.04,ease:"back.out(1.5)"})}animateTicks(e){this.g&&this.g.fromTo(e,{scale:0},{scale:1,duration:.3,ease:"back.out(2)"})}bounceIn(e){this.g&&this.g.fromTo(e,{scale:0,opacity:0},{scale:1,opacity:1,duration:.5,ease:"elastic.out(1.2, 0.4)"})}fanOutButtons(e){this.g&&this.g.fromTo(e,{scale:0,opacity:0,y:20},{scale:1,opacity:1,y:0,duration:.3,stagger:.06,ease:"back.out(2)"})}fanInButtons(e,t){if(!this.g){t?.();return}this.g.to(e,{scale:0,opacity:0,y:20,duration:.2,stagger:.03,ease:"back.in(2)",onComplete:t})}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};var ee=class a{constructor(){this.animation=y(U);this.isThemeTransitioning=!1;this.currentTheme=m(this.loadSavedTheme());this.isDarkMode=m(this.getThemeInfo(this.loadSavedTheme()).isDark)}static{this.themes=[{id:"classic",label:"Classic",icon:"ph-sun",isDark:!1},{id:"night",label:"Night",icon:"ph-moon",isDark:!0},{id:"midnight",label:"Midnight",icon:"ph-moon-stars",isDark:!0},{id:"rose",label:"Rose Gold",icon:"ph-flower-tulip",isDark:!0}]}get themes(){return a.themes}getThemeInfo(e){return a.themes.find(t=>t.id===e)||a.themes[1]}loadSavedTheme(){try{let e=localStorage.getItem("telegram-theme");if(e&&a.themes.some(t=>t.id===e))return e}catch{}return"night"}setTheme(e,t){if(e===this.currentTheme()||this.isThemeTransitioning)return;let i=t?.clientX??window.innerWidth/2,s=t?.clientY??50;this.isThemeTransitioning=!0,this.animation.morphThemeTransition(i,s,()=>{this.applyTheme(e)},()=>{this.isThemeTransitioning=!1})}toggleTheme(e){let t=["classic","night","midnight","rose"],i=t.indexOf(this.currentTheme()),s=t[(i+1)%t.length];this.setTheme(s,e)}applyTheme(e){let t=this.getThemeInfo(e),i=document.documentElement;i.setAttribute("data-theme",e),t.isDark?i.classList.add("dark"):i.classList.remove("dark"),this.currentTheme.set(e),this.isDarkMode.set(t.isDark);try{localStorage.setItem("telegram-theme",e)}catch{}}init(){this.applyTheme(this.currentTheme())}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};var k=class a{constructor(){this.audioCtx=null}getAudioCtx(){return this.audioCtx||(this.audioCtx=new AudioContext),this.audioCtx}playSendSound(){this.playTone(880,.08,"sine",.15),setTimeout(()=>this.playTone(1100,.06,"sine",.1),60)}playReceiveSound(){this.playTone(660,.1,"sine",.12),setTimeout(()=>this.playTone(880,.08,"sine",.08),80)}playReactionSound(){this.playTone(523,.06,"sine",.12),setTimeout(()=>this.playTone(659,.06,"sine",.1),50),setTimeout(()=>this.playTone(784,.06,"sine",.08),100)}playPopSound(){this.playTone(600,.05,"sine",.15)}playTone(e,t,i="sine",s=.1){try{let n=this.getAudioCtx(),r=n.createOscillator(),o=n.createGain();r.type=i,r.frequency.setValueAtTime(e,n.currentTime),o.gain.setValueAtTime(s,n.currentTime),o.gain.exponentialRampToValueAtTime(.001,n.currentTime+t),r.connect(o),o.connect(n.destination),r.start(n.currentTime),r.stop(n.currentTime+t)}catch{}}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};var z=class a{constructor(){this.dbName="TelegramCloneVoices";this.storeName="voiceBlobs";this.dbPromise=new Promise((e,t)=>{let i=indexedDB.open(this.dbName,1);i.onupgradeneeded=s=>{s.target.result.createObjectStore(this.storeName)},i.onsuccess=()=>e(i.result),i.onerror=()=>t(i.error)})}async saveVoice(e,t){let i=await this.dbPromise;return new Promise((s,n)=>{let c=i.transaction(this.storeName,"readwrite").objectStore(this.storeName).put(t,e);c.onsuccess=()=>s(),c.onerror=()=>n(c.error)})}async getVoice(e){let t=await this.dbPromise;return new Promise((i,s)=>{let o=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);o.onsuccess=()=>i(o.result),o.onerror=()=>s(o.error)})}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};var L=class a{constructor(){this.connection=null;this.isConnected=m(!1);this.messageHandlers=[];this.messageDeletedHandlers=[];this.reactionHandlers=[];this.typingHandlers=[];this.stoppedTypingHandlers=[];this.onlineHandlers=[];this.offlineHandlers=[];this.statusHandlers=[]}async start(){if(!this.connection)try{let e=await import("./chunk-IDZ2Y6SO.js");this.connection=new e.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build(),this.connection.on("ReceiveMessage",t=>{this.messageHandlers.forEach(i=>i(t))}),this.connection.on("MessageDeleted",t=>{this.messageDeletedHandlers.forEach(i=>i(t))}),this.connection.on("ReactionUpdated",t=>{this.reactionHandlers.forEach(i=>i(t))}),this.connection.on("UserTyping",(t,i)=>{this.typingHandlers.forEach(s=>s(t,i))}),this.connection.on("UserStoppedTyping",(t,i)=>{this.stoppedTypingHandlers.forEach(s=>s(t,i))}),this.connection.on("UserOnline",t=>{this.onlineHandlers.forEach(i=>i(t))}),this.connection.on("UserOffline",t=>{this.offlineHandlers.forEach(i=>i(t))}),this.connection.on("MessageStatusChanged",(t,i)=>{this.statusHandlers.forEach(s=>s(t,i))}),this.connection.onreconnected(()=>{this.isConnected.set(!0)}),this.connection.onclose(()=>{this.isConnected.set(!1)}),await this.connection.start(),this.isConnected.set(!0)}catch(e){console.error("SignalR connection failed:",e),this.isConnected.set(!1)}}async stop(){this.connection&&(await this.connection.stop(),this.connection=null,this.isConnected.set(!1))}async joinChat(e){this.connection&&await this.connection.invoke("JoinChat",e)}async leaveChat(e){this.connection&&await this.connection.invoke("LeaveChat",e)}async startTyping(e){this.connection&&await this.connection.invoke("StartTyping",e)}async stopTyping(e){this.connection&&await this.connection.invoke("StopTyping",e)}async messageDelivered(e,t){this.connection&&await this.connection.invoke("MessageDelivered",e,t)}async messageSeen(e,t){this.connection&&await this.connection.invoke("MessageSeen",e,t)}onMessage(e){return this.messageHandlers.push(e),()=>{this.messageHandlers=this.messageHandlers.filter(t=>t!==e)}}onMessageDeleted(e){return this.messageDeletedHandlers.push(e),()=>{this.messageDeletedHandlers=this.messageDeletedHandlers.filter(t=>t!==e)}}onReactionUpdated(e){return this.reactionHandlers.push(e),()=>{this.reactionHandlers=this.reactionHandlers.filter(t=>t!==e)}}onUserTyping(e){return this.typingHandlers.push(e),()=>{this.typingHandlers=this.typingHandlers.filter(t=>t!==e)}}onUserStoppedTyping(e){return this.stoppedTypingHandlers.push(e),()=>{this.stoppedTypingHandlers=this.stoppedTypingHandlers.filter(t=>t!==e)}}onUserOnline(e){return this.onlineHandlers.push(e),()=>{this.onlineHandlers=this.onlineHandlers.filter(t=>t!==e)}}onUserOffline(e){return this.offlineHandlers.push(e),()=>{this.offlineHandlers=this.offlineHandlers.filter(t=>t!==e)}}onMessageStatusChanged(e){return this.statusHandlers.push(e),()=>{this.statusHandlers=this.statusHandlers.filter(t=>t!==e)}}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};var ne={0:"sending",1:"sent",2:"delivered",3:"seen"},re={0:"direct",1:"group",2:"channel"},te=class a{constructor(){this.voiceStorage=y(z);this.audio=y(k);this.api=y(Z);this.auth=y(Q);this.hub=y(L);this.currentUser=T(()=>this.auth.currentUser()??{id:"",name:"",isOnline:!1});this.chats=m([]);this.messages=m([]);this.typingUsers=m(new Map);this.usersCache=new Map;this.loadedChatMessages=new Set;this.initialized=!1;this.setupSignalRHandlers(),V(()=>{let e=this.auth.currentUser();e&&!this.initialized?(this.initialized=!0,this.loadChats()):e||(this.initialized=!1,this.chats.set([]),this.messages.set([]),this.usersCache.clear(),this.loadedChatMessages.clear())})}setupSignalRHandlers(){this.hub.onMessage(e=>{let t=this.mapMessage(e);t.senderId!==this.currentUser().id&&(this.messages.update(i=>[...i,t]),this.chats.update(i=>i.map(s=>s.id===t.chatId?v(p({},s),{lastMessage:t,unreadCount:s.unreadCount+1}):s)),this.audio.playReceiveSound())}),this.hub.onMessageDeleted(e=>{this.updateMessage(e,{isDeleted:!0})}),this.hub.onReactionUpdated(e=>{if(e.messageId&&e.reactions){let t=e.reactions.map(i=>({emoji:i.emoji,userIds:(i.userIds||[]).map(s=>String(s))}));this.updateMessage(String(e.messageId),{reactions:t})}}),this.hub.onUserTyping((e,t)=>this.setTyping(e,t,!0)),this.hub.onUserStoppedTyping((e,t)=>this.setTyping(e,t,!1)),this.hub.onUserOnline(e=>this.updateUserOnlineStatus(e,!0)),this.hub.onUserOffline(e=>this.updateUserOnlineStatus(e,!1)),this.hub.onMessageStatusChanged((e,t)=>{this.updateMessage(e,{status:t})})}async loadChats(){try{let e=await this.api.getChats().toPromise();if(!e)return;let t=e.map(i=>this.mapChat(i));this.chats.set(t);for(let i of t)for(let s of i.participants)this.usersCache.set(s.id,s);for(let i of t)this.hub.joinChat(i.id).catch(()=>{});await Promise.all(t.map(i=>this.ensureMessagesLoaded(i.id)))}catch(e){console.error("Failed to load chats:",e)}}async ensureMessagesLoaded(e){if(!this.loadedChatMessages.has(e)){this.loadedChatMessages.add(e);try{let t=await this.api.getMessages(e).toPromise();if(!t)return;let i=t.map(s=>this.mapMessage(s));this.messages.update(s=>[...s.filter(n=>n.chatId!==e),...i]),this.restoreVoiceUrls(e)}catch(t){console.error("Failed to load messages for",e,t),this.loadedChatMessages.delete(e)}}}mapChat(e){return{id:String(e.id),type:typeof e.type=="number"?re[e.type]??"direct":e.type||"direct",participants:(e.participants||[]).map(t=>this.mapUser(t)),lastMessage:e.lastMessage?this.mapMessage(e.lastMessage):void 0,unreadCount:e.unreadCount??0,isPinned:e.isPinned??!1,isArchived:e.isArchived??!1,name:e.name,avatarUrl:e.avatarUrl,description:e.description,memberCount:e.memberCount}}mapMessage(e){return{id:String(e.id),chatId:String(e.chatId),senderId:String(e.senderId),text:e.text,timestamp:e.timestamp?new Date(e.timestamp).getTime():Date.now(),status:typeof e.status=="number"?ne[e.status]??"sent":e.status||"sent",attachments:e.attachments,voice:e.voice?{url:e.voice.url||"",duration:e.voice.duration||0,durationMs:e.voice.durationMs||0,waveform:e.voice.waveform||[],storageKey:e.voice.storageKey}:void 0,replyToId:e.replyToId?String(e.replyToId):void 0,isDeleted:e.isDeleted??!1,reactions:(e.reactions||[]).map(t=>({emoji:t.emoji,userIds:(t.userIds||[]).map(i=>String(i))}))}}mapUser(e){return{id:String(e.id),name:e.name||e.displayName||"",username:e.username,bio:e.bio,avatarUrl:e.avatarUrl,isOnline:e.isOnline??!1,lastSeen:e.lastSeen?new Date(e.lastSeen).getTime():void 0}}getChatById(e){return this.chats().find(t=>t.id===e)}getMessagesForChat(e){return this.ensureMessagesLoaded(e),T(()=>this.messages().filter(t=>t.chatId===e&&!t.isDeleted).sort((t,i)=>t.timestamp-i.timestamp))}getMessageById(e){return this.messages().find(t=>t.id===e)}getParticipant(e){if(!(e.type==="group"||e.type==="channel"))return e.participants.find(t=>t.id!==this.currentUser().id)}addMessage(e){this.messages.update(t=>[...t,e]),this.chats.update(t=>{let i=t.findIndex(o=>o.id===e.chatId);if(i===-1)return t;let s=v(p({},t[i]),{lastMessage:e,unreadCount:0}),n=[...t];n.splice(i,1);let r=s.isPinned?0:t.filter(o=>o.isPinned).length;return n.splice(r,0,s),n}),e.senderId===this.currentUser().id&&this.api.sendMessage(e.chatId,{text:e.text,replyToId:e.replyToId}).subscribe({error:t=>console.error("Failed to send message:",t)})}updateMessage(e,t){this.messages.update(i=>i.map(s=>s.id===e?p(p({},s),t):s))}deleteMessage(e){let t=this.getMessageById(e);return t?(this.updateMessage(e,{isDeleted:!0}),this.api.deleteMessage(t.chatId,e).subscribe({error:i=>console.error("Failed to delete message:",i)}),!0):!1}addReaction(e,t){let i=this.getMessageById(e);if(!i)return;let s=this.currentUser().id;this.messages.update(n=>n.map(r=>{if(r.id!==e)return r;let o=[...r.reactions||[]],c=o.find(l=>l.emoji===t);if(c){if(c.userIds.includes(s)){if(c.userIds=c.userIds.filter(l=>l!==s),c.userIds.length===0)return v(p({},r),{reactions:o.filter(l=>l.emoji!==t)})}else c.userIds=[...c.userIds,s];return v(p({},r),{reactions:[...o]})}return v(p({},r),{reactions:[...o,{emoji:t,userIds:[s]}]})})),this.audio.playReactionSound(),this.api.addReaction(i.chatId,e,t).subscribe({error:n=>console.error("Failed to add reaction:",n)})}markAsRead(e){this.chats.update(t=>t.map(i=>i.id===e?v(p({},i),{unreadCount:0}):i))}updateCurrentUserProfile(e){let t=this.currentUser();this.auth.updateProfile({name:(e.name??t.name).trim()||t.name,username:(e.username??t.username??"").trim()||t.username||"my_account",bio:(e.bio??t.bio??"").trim(),avatarUrl:e.avatarUrl})}setTyping(e,t,i){this.typingUsers.update(s=>{let n=new Map(s),r=n.get(e)||[];return i&&!r.includes(t)?n.set(e,[...r,t]):i||n.set(e,r.filter(o=>o!==t)),n})}getTypingUsersForChat(e){return this.typingUsers().get(e)||[]}getUserById(e){return e===this.currentUser().id?this.currentUser():this.usersCache.get(e)}getNonArchivedChats(){return T(()=>this.chats().filter(e=>!e.isArchived))}async startDirectChat(e){try{let t=await this.api.createChat({type:"Direct",participantIds:[e]}).toPromise();if(!t)return null;let i=this.mapChat(t);this.chats.update(s=>s.find(r=>r.id===i.id)?s:[i,...s]);for(let s of i.participants)this.usersCache.set(s.id,s);return this.hub.joinChat(i.id).catch(()=>{}),i.id}catch(t){return console.error("Failed to start direct chat:",t),null}}getArchivedChats(){return T(()=>this.chats().filter(e=>e.isArchived))}async restoreVoiceUrls(e){let t=this.messages().filter(s=>s.chatId===e),i=!1;for(let s of t)if(s.voice&&s.voice.storageKey&&!s.voice.url){let n=await this.voiceStorage.getVoice(s.voice.storageKey);n&&(s.voice.url=URL.createObjectURL(n),i=!0)}i&&this.messages.set([...this.messages()])}updateUserOnlineStatus(e,t){let i=this.usersCache.get(e);i&&this.usersCache.set(e,v(p({},i),{isOnline:t,lastSeen:t?void 0:Date.now()})),this.chats.update(s=>s.map(n=>v(p({},n),{participants:n.participants.map(r=>r.id===e?v(p({},r),{isOnline:t,lastSeen:t?void 0:Date.now()}):r)})))}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275prov=h({token:a,factory:a.\u0275fac,providedIn:"root"})}};function ae(a,e){a&1&&F(0,"div",5)}function oe(a,e){if(a&1){let t=K();E(0,"img",4),Y("load",function(){A(t);let s=I();return N(s.onLoad())})("error",function(){A(t);let s=I();return N(s.onError())}),C(),S(1,ae,1,0,"div",5)}if(a&2){let t=I();G("opacity-0",!t.imgLoaded())("opacity-100",t.imgLoaded()),W("src",t.src(),q),w(),H(t.imgLoaded()?-1:1)}}function ce(a,e){if(a&1&&(E(0,"span"),X(1),C()),a&2){let t=I();O(t.textSizeClass()),w(),J(t.initials())}}function le(a,e){a&1&&F(0,"div",3)}var ie=class a{constructor(){this.src=P();this.name=P("");this.size=P("md");this.isOnline=P(!1);this.imgLoaded=m(!1);this.imgError=m(!1);this.sizeClasses=T(()=>{switch(this.size()){case"xs":return"w-8 h-8";case"sm":return"w-10 h-10";case"lg":return"w-16 h-16";default:return"w-12 h-12"}});this.textSizeClass=T(()=>{switch(this.size()){case"xs":return"text-xs";case"sm":return"text-sm";case"lg":return"text-xl";default:return"text-base"}});this.initials=T(()=>{let e=this.name();if(!e)return"?";let t=e.split(" ");return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():e.substring(0,2).toUpperCase()})}onLoad(){this.imgLoaded.set(!0)}onError(){this.imgError.set(!0)}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275cmp=$({type:a,selectors:[["app-avatar"]],inputs:{src:[1,"src"],name:[1,"name"],size:[1,"size"],isOnline:[1,"isOnline"]},decls:5,vars:4,consts:[[1,"relative","rounded-full","flex","items-center","justify-center","overflow-visible","shrink-0","transition-transform","active:scale-90"],[1,"w-full","h-full","rounded-full","overflow-hidden","bg-gradient-to-br","from-blue-400","to-telegram-primary","text-white","font-medium","flex","items-center","justify-center","relative"],[3,"class"],[1,"absolute","bottom-0","right-0","w-3","h-3","bg-green-500","border-2","border-white","dark:border-telegram-surface","rounded-full","z-10"],["alt","Avatar",1,"w-full","h-full","object-cover","transition-opacity","duration-300",3,"load","error","src"],[1,"absolute","inset-0","shimmer-bg","bg-gray-300","dark:bg-gray-700","rounded-full"]],template:function(t,i){t&1&&(E(0,"div",0)(1,"div",1),S(2,oe,2,6)(3,ce,2,3,"span",2),C(),S(4,le,1,0,"div",3),C()),t&2&&(O(i.sizeClasses()),w(2),H(i.src()&&!i.imgError()?2:3),w(2),H(i.isOnline()?4:-1))},encapsulation:2})}};var se=class a{transform(e){if(!e)return"";let t=new Date(e),i=t.getHours(),s=t.getMinutes(),n=i>=12?"PM":"AM";i=i%12,i=i||12;let r=s<10?"0"+s:s;return i+":"+r+" "+n}static{this.\u0275fac=function(t){return new(t||a)}}static{this.\u0275pipe=_({name:"shortTime",type:a,pure:!0})}};export{U as a,ee as b,L as c,z as d,k as e,te as f,ie as g,se as h};
